<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Visor 360º GDIE P2</title>
    <script src="https://aframe.io/releases/0.9.0/aframe.min.js"></script>
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>

<!--al fer click a la esfera verda, redireccionar la web-->
<script>
    AFRAME.registerComponent('clickable', {
        init: function () {
            this.index = 0;
            this.el.addEventListener('click', e => {
                if (this.el.id === "r12b") {
                    window.location.hash = "r12b";
                }else if (this.el.id === "p18"){
                    console.log(this.el.id);
                    window.location.hash = "p18";
                }else if (this.el.id === "r4b"){
                    console.log(this.el.id);
                    window.location.hash = "r4b";
                }else if (this.el.id === "p5"){
                    console.log(this.el.id);
                    window.location.hash = "p5";
                }else if (this.el.id === "r21a"){
                    console.log(this.el.id);
                    window.location.hash = "r21a";
                }
            });
        }
    });
</script>

<!--listener hashstagechange: al canviar de hash, realitzar unes accions determinades-->

<!--Crea bolles dinàmiques-->
<script>
    AFRAME.registerSystem('hypervideo', {
        tracking: [
            {
                t: 0,
                lat: 24.40,
                lon: -4.95
            },
            {
                t: 1,
                lat: 32.80,
                lon: -29.25
            },
            {
                t: 2,
                lat: 43.60,
                lon: -58.05
            },
            {
                t: 3,
                lat: 46.40,
                lon: -119.70
            },
            {
                t: 20,
                lat: 24.80,
                lon: -156.15
            }],
        init: function() {
            var entity = this.entity = document.createElement('a-sphere');
            entity.setAttribute('color', 'red');
            entity.setAttribute('radius', '5');
            entity.setAttribute('position', '0 0 -100');
            this.el.appendChild(entity);

            this.video = document.querySelector('video');
        },
        tick: function() {
            let t = this.video.currentTime;
            // Trobam els trackings t0 i t1, t0.t < t < t1.t.
            let t0, t1;
            for (let i = 0; i < this.tracking.length - 1 && t0 === undefined; i++) {
                // Han d'estar ordenats!
                if (this.tracking[i],t <= t && t < this.tracking[i + 1].t) {
                    t0 = this.tracking[i];
                    t1 = this.tracking[i + 1];
                }
            }
            // Si els hem trobat, hem de mostrar el punt a unes coordenades intermitges
            if (t0 !== undefined) {
                let f = (t - t0.t) / (t1.t - t0.t);
                let lat0 = t0.lat * Math.PI / 180;
                let lon0 = t0.lon * Math.PI / 180;
                let lat1 = t1.lat * Math.PI / 180;
                let lon1 = t1.lon * Math.PI / 180;

                const R = 100;

                let d = Math.acos(Math.cos(lat0) * Math.cos(lat1) * Math.cos(lon1 - lon0) + Math.sin(lat0) * Math.sin(lat1));
                let A = Math.sin((1 - f) * d) / Math.sin(d);
                let B = Math.sin(f * d) / Math.sin(d);
                let x = R * (A * Math.cos(lat0) * Math.sin(lon0) + B * Math.cos(lat1) * Math.sin(lon1));
                let y = R * (A * Math.sin(lat0) + B * Math.sin(lat1));
                let z = -R * (A * Math.cos(lat0) * Math.cos(lon0) + B * Math.cos(lat1) * Math.cos(lon1));
                this.entity.setAttribute('visible', 'true'); // Aixòs'ha de poder optimitzar!
                this.entity.setAttribute('position', { x, y, z });
            } else {
                this.entity.setAttribute('visible', 'false');
            }
        }
    });
</script>

<a-scene id="escena" inspector="" keyboard-shortcuts="" screenshot="" vr-mode-ui="">
    <a-assets>
        <video data-dashjs-player id="idsrc" autoplay crossorigin loop muted
               src="https://ltim.uib.es/files/palma360/r12a/720.mp4">
        </video>
    </a-assets>
    <a-videosphere rotation="0 -90 0" src="#idsrc"></a-videosphere>
    <a-entity id="punts">

    </a-entity >

   <a-entity  camera="" look-controls="" position="0 1.6 0" rotation="">
       <a-entity cursor="" position="0 0 -1" geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                 material="color: black; shader: flat" raycaster="" >
       </a-entity>
   </a-entity>

   <canvas class="a-canvas a-grab-cursor" data-aframe-canvas="true" width="1366" height="635" style=""></canvas>
   <div class="a-loader-title" style="display: none;">GDIE 360º</div>
   <div class="a-enter-vr" aframe-injected="">
       <button class="a-enter-vr-button"
               title="Enter VR mode with a headset or fullscreen mode on a desktop."
               aframe-injected=""></button>
   </div>
   <div class="a-orientation-modal a-hidden" aframe-injected="">
       <button aframe-injected="">Exit VR</button>
   </div>
   <a-entity light="" data-aframe-default-light="" aframe-injected=""></a-entity>
   <a-entity light="" position="" data-aframe-default-light="" aframe-injected=""></a-entity>
   </a-scene>
<script src="functions.js"></script>
</body>
</html>