<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Visor 360º GDIE P2</title>
    <script src="https://aframe.io/releases/0.9.0/aframe.min.js"></script>
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
</head>
<body>

<!--al fer click a la esfera verda, redireccionar la web-->
<script>
    AFRAME.registerComponent('clickable', {
        init: function () {
            this.index = 0;
            this.el.addEventListener('click', e => {
                if (this.el.id === "r12b") {
                    window.location.hash = "r12b";
                }else if (this.el.id === "p18"){
                    console.log(this.el.id);
                    window.location.hash = "p18";
                }else if (this.el.id === "r4b"){
                    console.log(this.el.id);
                    window.location.hash = "r4b";
                }
            });
        }
    });
</script>

<!--listener hashstagechange: al canviar de hash, realitzar unes accions determinades-->
<script>
    window.addEventListener('hashchange', function (e) {
        console.log("Accions a partir del canvi de hash: "+ window.location.hash);
        switch(window.location.hash) {
            <!--Primera ruta-->
            case "#p10":
                document.getElementById("idsrc").src="https://ltim.uib.es/files/palma360/p10/720.mp4";
                document.getElementById("r12b").setAttribute('visible','true');
                document.getElementById("p18").setAttribute('visible','true');
                document.getElementById("r4b").setAttribute('visible','true');
                <!--Aqui se tienen que poner a false todos los puntos-->
                break;
            case "#r12b":
                document.getElementById("idsrc").src="https://ltim.uib.es/files/palma360/r12b/720.mp4";
                document.getElementById("r12b").setAttribute('visible','false');
                document.getElementById("p18").setAttribute('visible','false');
                document.getElementById("r4b").setAttribute('visible','false');
                <!--Aqui se tienen que poner a false todos los puntos-->
                break;
            case "#p20":
                document.getElementById("idsrc").src="https://ltim.uib.es/files/palma360/p20/720.mp4"; //Ruta d'altre
                document.getElementById("r11b").setAttribute('visible','true');
                document.getElementById("r18a").setAttribute('visible','true');
                document.getElementById("r18b").setAttribute('visible','true');
                document.getElementById("r12a").setAttribute('visible','true');
                <!--Aqui se tienen que poner a false todos los puntos-->
                document.getElementById("r12b").setAttribute('visible','false');
                document.getElementById("p18").setAttribute('visible','false');
                document.getElementById("r4b").setAttribute('visible','false');
                break;
            case "#r12a":
                document.getElementById("idsrc").src="https://ltim.uib.es/files/palma360/r12b/720.mp4";
                document.getElementById("r12b").setAttribute('visible','false');
                document.getElementById("p18").setAttribute('visible','false');
                document.getElementById("r4b").setAttribute('visible','false');
                <!--Aqui se tienen que poner a false todos los puntos-->
                break;

            <!--Segunda ruta-->
            case "#p32":
                document.getElementById("idsrc").src="https://ltim.uib.es/files/palma360/p32/720.mp4";
                document.getElementById("r21a").setAttribute('visible','true');
                document.getElementById("p5").setAttribute('visible','true');
                <!--Aqui se tienen que poner a false todos los puntos-->
                break;
            case "#r20b":
                document.getElementById("idsrc").src="https://ltim.uib.es/files/palma360/r20b/720.mp4";
                document.getElementById("r21a").setAttribute('visible','false');
                document.getElementById("p5").setAttribute('visible','false');
                <!--Aqui se tienen que poner a false todos los puntos-->
                break;
            case "#p5":
                document.getElementById("idsrc").src="https://ltim.uib.es/files/palma360/p5/720.mp4";
                document.getElementById("r11b").setAttribute('visible','true');
                document.getElementById("r18a").setAttribute('visible','true');
                document.getElementById("r18b").setAttribute('visible','true');
                document.getElementById("r12a").setAttribute('visible','true');
                <!--Aqui se tienen que poner a false todos los puntos-->
                break;
            case "#r20a":
                document.getElementById("idsrc").src="https://ltim.uib.es/files/palma360/r20a/720.mp4";
                document.getElementById("r11b").setAttribute('visible','false');
                document.getElementById("r18a").setAttribute('visible','false');
                document.getElementById("r18b").setAttribute('visible','false');
                document.getElementById("r12a").setAttribute('visible','false');
                break;
            <!--A partir de aquí son cosas de otros. Quitamos nuestros puntos.-->
            <!--p10-->
            case "#p18":
                <!--Aqui se tienen que poner a false todos los puntos-->
                break;
            case "#r4b":
                <!--Aqui se tienen que poner a false todos los puntos-->
                break;
            <!--p20-->
            case "#r11b":
                <!--Aqui se tienen que poner a false todos los puntos-->
                break;
            case "#r18a":
                <!--Aqui se tienen que poner a false todos los puntos-->
                break;
            case "#r18b":
                <!--Aqui se tienen que poner a false todos los puntos-->
                break;

            <!--p32-->
            case "#r21a":
                <!--Aqui se tienen que poner a false todos los puntos-->
                break;
            <!--p5-->
            case "#r2b":
                <!--Aqui se tienen que poner a false todos los puntos-->
                break;
            case "#r10b":
                <!--Aqui se tienen que poner a false todos los puntos-->
                break;
            default:
            console.log("default case del switch");
        }
    });
</script>

<!--Crea bolles dinàmiques-->
<script>
    AFRAME.registerSystem('hypervideo', {
        tracking: [
            {
                t: 0,
                lat: -46.8,
                lon: 141.8
            },
            {
                t: 5,
                lat: -7.2,
                lon: -172.4
            },
            {
                t: 10,
                lat: 4,
                lon: -100.9
            }],
        init: function() {
            const entity = this.entity = document.createElement('a-sphere');
            entity.setAttribute('color', 'red');
            entity.setAttribute('radius', '5');
            entity.setAttribute('position', '0 0 -100');
            this.el.appendChild(entity);
            this.video = document.querySelector('video');
        },
        tick: function() {
            let t = this.video.currentTime;
            // Trobam els trackings t0 i t1, t0.t < t < t1.t.
            let t0, t1;
            for (let i = 0; i < this.tracking.length - 1 && t0 === undefined; i++) {
                // Han d'estar ordenats!
                if (this.tracking[i],t <= t && t < this.tracking[i + 1].t) {
                    t0 = this.tracking[i];
                    t1 = this.tracking[i + 1];
                }
            }
            // Si els hem trobat, hem de mostrar el punt a unes coordenades intermitges
            if (t0 !== undefined) {
                let f = (t - t0.t) / (t1.t - t0.t);
                let lat0 = t0.lat * Math.PI / 180;
                let lon0 = t0.lon * Math.PI / 180;
                let lat1 = t1.lat * Math.PI / 180;
                let lon1 = t1.lon * Math.PI / 180;

                const R = 100;

                let d = Math.acos(Math.cos(lat0) * Math.cos(lat1) * Math.cos(lon1 - lon0) + Math.sin(lat0) * Math.sin(lat1));
                let A = Math.sin((1 - f) * d) / Math.sin(d);
                let B = Math.sin(f * d) / Math.sin(d);
                let x = R * (A * Math.cos(lat0) * Math.sin(lon0) + B * Math.cos(lat1) * Math.sin(lon1));
                let y = R * (A * Math.sin(lat0) + B * Math.sin(lat1));
                let z = -R * (A * Math.cos(lat0) * Math.cos(lon0) + B * Math.cos(lat1) * Math.cos(lon1));
                this.entity.setAttribute('visible', 'true'); // Aixòs'ha de poder optimitzar!
                this.entity.setAttribute('position', { x, y, z });
            } else {
                this.entity.setAttribute('visible', 'false');
            }
        }
    });
</script>

<a-scene inspector="" keyboard-shortcuts="" screenshot="" vr-mode-ui="">
    <a-assets>
        <video data-dashjs-player id="idsrc" autoplay crossorigin loop muted
               src="https://ltim.uib.es/files/palma360/p10/720.mp4">
        </video>
    </a-assets>
    <a-videosphere rotation="0 -90 0" src="#idsrc"></a-videosphere>

    <!--p10-->
    <a-sphere id="p18"  class="clickable" color="red"    radius="1.5" position="45 1.6 0"   clickable></a-sphere>
    <a-sphere id="r12b" class="clickable" color="green"  radius="1.2" position="0 2 -20"    clickable></a-sphere>
    <a-sphere id="r4b"  class="clickable" color="orange" radius="1.5" position="-45 1.6 0"  clickable></a-sphere>
    <a-text value="r4b" width="15" position="-10.000 2.500 2.500"
            rotation="0.000 90.000 -2.000" text=""></a-text>

    <!--p20-->
    <a-sphere id="r11b" color="red"    radius="1.5" position="45 1.6 0"   visible="false"></a-sphere>
    <a-sphere id="r18a" color="green"  radius="1.5" position="0 2 -20"    visible="false"></a-sphere>
    <a-sphere id="r18b" color="orange" radius="1.5" position="0 5 -20"    visible="false"></a-sphere>
    <a-sphere id="r12a" color="blue"   radius="1.5" position="0 7 -20"    visible="false"></a-sphere>

    <!--p32-->
    <a-sphere id="r21a" color="red"    radius="1.5" position="-45 1.6 0"  visible="false"></a-sphere>
    <a-sphere id="p5"   color="orange" radius="1.5" position="-45 1.6 0"  visible="false"></a-sphere>
    <a-sphere id="p20b" color="orange" radius="1.5" position="-45 1.6 0"  visible="false"></a-sphere>

    <!--p5-->
    <a-sphere id="r2b"  color="red"    radius="1.5" position="45 1.6 0"   visible="false"></a-sphere>
    <a-sphere id="r10b" color="green"  radius="1.5" position="-0 2 -20"   visible="false"></a-sphere>
    <a-sphere id="r20a" color="orange" radius="1.5" position="-45 1.6 0"  visible="false"></a-sphere>

    <a-entity camera="" look-controls="" position="0 1.6 0" rotation="">
        <a-entity cursor="" position="0 0 -1" geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                  material="color: black; shader: flat" raycaster="">
        </a-entity>
    </a-entity>

    <canvas class="a-canvas a-grab-cursor" data-aframe-canvas="true" width="1366" height="635" style=""></canvas>
    <div class="a-loader-title" style="display: none;">GDIE 360º</div>
    <div class="a-enter-vr" aframe-injected="">
        <button class="a-enter-vr-button"
                title="Enter VR mode with a headset or fullscreen mode on a desktop."
                aframe-injected=""></button>
    </div>
    <div class="a-orientation-modal a-hidden" aframe-injected="">
        <button aframe-injected="">Exit VR</button>
    </div>
    <a-entity light="" data-aframe-default-light="" aframe-injected=""></a-entity>
    <a-entity light="" position="" data-aframe-default-light="" aframe-injected=""></a-entity>
    </a-scene>
</body>
</html>